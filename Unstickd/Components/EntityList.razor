@using Unstickd.Models
@using Unstickd.Components.Shared
@using Microsoft.EntityFrameworkCore
@inject AppDbContext DbContext
@inject StoryState StoryState

<EntityEditor @ref="entityEditor" Entity="SelectedEntity" OnSaved="ReloadEntities" />

@code {
    [Parameter] public string NotebookTypeName { get; set; } = string.Empty;
    private List<NotebookEntity> Entities = new();
    private string TypeIcon = "";
    private NotebookEntity? SelectedEntity;
    private EntityEditor? entityEditor;

    protected override async Task OnInitializedAsync() => await ReloadEntities();

    private async Task ReloadEntities()
    {
        var type = await DbContext.NotebookTypes.FirstOrDefaultAsync(t => t.Name == NotebookTypeName);
        if (type != null)
        {
            TypeIcon = type.Icon;
            Entities = await DbContext.Notebooks
                .Where(n => n.AccountId == 1 && n.Name == NotebookTypeName)
                .SelectMany(n => n.Entities)
                .Include(e => e.Entries)
                .Include(e => e.StoryLinks)
                .ToListAsync();
        }
        StateHasChanged();
    }

    private void EditEntity(NotebookEntity entity)
    {
        SelectedEntity = entity;
        entityEditor?.Open();
    }
}

@if (Entities.Count == 0)
{
    <div class="alert alert-info">No @NotebookTypeName entities found.</div>
}
else
{
    <ul class="list-group">
        @foreach (var entity in Entities)
        {
            <li class="list-group-item" style="cursor:pointer;" @onclick="() => EditEntity(entity)">
                <i class="bi @TypeIcon me-2"></i>
                <strong>@entity.Name</strong>
                <span class="text-muted">@entity.Description</span>
                @if (entity.StoryLinks != null && entity.StoryLinks.Count > 0)
                {
                    <div class="small mt-1">
                        Appears in:
                        @foreach (var link in entity.StoryLinks)
                        {
                            <span class="badge bg-secondary me-1">@link.Story?.Title</span>
                        }
                    </div>
                }
            </li>
        }
    </ul>
}
