@using Unstickd.Services
@using Unstickd.Models
@using Microsoft.JSInterop
@inject StoryState StoryState
@inject IHttpClientFactory HttpClientFactory
@inject IJSRuntime JS
@implements IAsyncDisposable
@using Serilog

<div class="tutor-overlay">
    <!-- Speech Bubble (Visible when NOT expanded, or explicitly shown) -->
    @if (!IsExpanded && !string.IsNullOrEmpty(StoryState.TutorNotes))
    {
        <div class="tutor-bubble">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <small class="fw-bold text-primary">Alice suggestion:</small>
                <button type="button" class="btn-close btn-sm" aria-label="Close" @onclick="DismissTutorNote"></button>
            </div>
            <p class="small mb-1 text-truncate" style="max-width: 200px;">@StoryState.TutorNotes</p>
            <div class="text-end">
                <small class="text-primary" style="cursor: pointer;" @onclick="ToggleExpand">Open Chat</small>
            </div>
        </div>
    }

    <!-- Expanded Chat Window -->
    @if (IsExpanded) 
    {
        <div class="tutor-window">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center p-3 rounded-top">
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-robot"></i>
                    <h6 class="m-0">Creative Assistant</h6>
                </div>
                <button type="button" class="btn-close btn-close-white" @onclick="ToggleExpand"></button>
            </div>
            
            <div class="card-body overflow-auto p-3 bg-light" style="height: 300px;">
                @if (IsLoadingAI)
                {
                    <div class="d-flex justify-content-center align-items-start pt-4 h-100">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Thinking...</span>
                        </div>
                    </div>
                }
                else
                {
                    <!-- Current State / Notes -->
                     @if (!string.IsNullOrEmpty(StoryState.TutorNotes))
                     {
                        <div class="alert alert-info border-0 shadow-sm">
                            <h6 class="alert-heading h6"><i class="bi bi-lightbulb-fill"></i> Idea:</h6>
                            <p class="mb-0 small" style="white-space: pre-wrap;">@StoryState.TutorNotes</p>
                            <div class="mt-2 text-end">
                                <button class="btn btn-sm btn-outline-info bg-white" @onclick="DismissTutorNote">Clear</button>
                            </div>
                        </div>
                     }
                     else
                     {
                        <!-- Idle States -->
                        <div class="text-center text-muted mt-4">
                            @if (CurrentTutorState == TutorState.Idle)
                            {
                                <i class="bi bi-emoji-smile fs-1 d-block mb-2"></i>
                                <p class="small">I'm reading along with you...</p>
                            }
                            else if (CurrentTutorState == TutorState.LookingUp)
                            {
                                <i class="bi bi-emoji-sunglasses fs-1 d-block mb-2"></i>
                                <p class="small">Deep in thought?</p>
                            }
                            else if (CurrentTutorState == TutorState.OfferingHelp)
                            {
                                <i class="bi bi-stars fs-1 d-block mb-2 text-warning"></i>
                                <p class="small mb-2">Need a spark?</p>
                                <button class="btn btn-sm btn-outline-success" @onclick="async () => { StoryState.TutorNotes = string.Empty; await OnHintClick(); }">
                                    Get a hint
                                </button>
                            }
                        </div>
                     }
                }
            </div>

            <div class="card-footer bg-white border-top p-2">
                <div class="input-group">
                    <textarea class="form-control border-0 bg-light" 
                              @bind="Prompt" 
                              @bind:event="oninput"
                              placeholder="Ask Alice..."
                              style="resize: none; height: 38px;"
                              @onkeydown="@EnterKeyHandler">
                    </textarea>
                    <button class="btn btn-primary" @onclick="AskTutor" disabled="@(IsLoadingAI || string.IsNullOrWhiteSpace(Prompt))">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- Avatar Toggle (Always Visible) -->
    <div class="tutor-avatar" @onclick="ToggleExpand" title="@GetTutorTooltip()">
        <img src="@GetTutorImage()" class="@(IsLoadingAI ? "pulsing" : "")" alt="Tutor Avatar" />
    </div>
</div>

@code {
    [Parameter]
    public Account? CurrentAccount { get; set; }

    private bool IsLoadingAI = false;
    // Default to false for widget
    private bool IsExpanded = false;
    private string Prompt = "";

    // --- Inactivity & Tutor Logic ---
    private enum TutorState { Idle, LookingUp, OfferingHelp }
    private TutorState CurrentTutorState = TutorState.Idle;
    private bool IsGlancingUp = false;
    private DotNetObjectReference<TutorPanel>? objRef;

    private void ToggleExpand() => IsExpanded = !IsExpanded;

    private async Task EnterKeyHandler(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await AskTutor();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            try 
            {
                await JS.InvokeVoidAsync("inactivityTimer.initialize", objRef);
            }
            catch (Exception)
            {
                // Graceful degradation
            }
        }
    }

    private async Task AskTutor()
    {
        if (string.IsNullOrWhiteSpace(Prompt)) return;

        IsLoadingAI = true;
        // Auto-expand to show loading state if not already
        if (!IsExpanded) IsExpanded = true;
        
        var currentPrompt = Prompt;
        Prompt = ""; // Clear input immediately
        
        try
        {
            var client = HttpClientFactory.CreateClient("LLM");
            if (CurrentAccount != null && !string.IsNullOrWhiteSpace(CurrentAccount.OllamaUrl))
            {
                client.BaseAddress = new Uri(CurrentAccount.OllamaUrl);
            }

            var modelName = CurrentAccount?.OllamaModel;
            if (string.IsNullOrWhiteSpace(modelName)) modelName = "llama3";
            
            var context = $"The user is writing a story titled '{StoryState.Title}'. Content snippet: '{Truncate(StoryState.Content, 500)}'.";
            var fullPrompt = $"System: You are a helpful creative writing coach named Alice. Be concise. Context: {context}. User: {currentPrompt}";

            var payload = new 
            { 
                model = modelName, 
                prompt = fullPrompt,
                stream = false 
            };
            
            var response = await client.PostAsJsonAsync("api/generate", payload);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LlamaResponse>();
                if (result != null)
                {
                    StoryState.TutorNotes = result.response;
                }
            }
            else
            {
                StoryState.TutorNotes = "I'm having trouble connecting to my brain (Ollama). Check your settings.";
            }
        }
        catch (Exception ex)
        {
            Log.Error(ex, "AI Error");
            StoryState.TutorNotes = "I couldn't reach the AI service. Is Ollama running?";
        }
        finally
        {
            IsLoadingAI = false;
            // Ensure expanded so they see the error or result
            IsExpanded = true;
            StateHasChanged();
        }
    }

    private async Task OnHintClick()
    {
        Prompt = "Give me a creative hint or plot twist for the current story.";
        await AskTutor();
    }
    
    // --- JS Interop Methods matching inactivity.js ---

    [JSInvokable]
    public void OnInactivityStage1()
    {
        // 15 seconds: Look up
        CurrentTutorState = TutorState.LookingUp;
        IsGlancingUp = true;
        StateHasChanged();
    }

    [JSInvokable]
    public void OnInactivityStage2()
    {
        // 30 seconds: Offer help
        CurrentTutorState = TutorState.OfferingHelp;
        IsGlancingUp = true; // Still looking up
        StateHasChanged();
    }

    [JSInvokable]
    public void OnActivityDetected()
    {
        // When user types, go back to reading
        if (CurrentTutorState != TutorState.Idle) 
        {
            CurrentTutorState = TutorState.Idle;
            IsGlancingUp = false;
            StateHasChanged();
        }
    }

    private string GetTutorImage()
    {
        // Use actual assets found in wwwroot/images
        if (CurrentTutorState == TutorState.OfferingHelp) return "/images/tutor_help.png";
        if (IsGlancingUp) return "/images/tutor_lookup.png"; 
        return "/images/tutor_reading.png"; 
    }

    private string GetTutorTooltip()
    {
        return IsExpanded ? "Close Chat" : "Ask Alice";
    }

    private void DismissTutorNote()
    {
        StoryState.TutorNotes = string.Empty;
    }

    // Helper
    private string Truncate(string input, int length)
    {
        if (string.IsNullOrEmpty(input) || input.Length <= length) return input;
        return input.Substring(0, length) + "...";
    }

    private class LlamaResponse
    {
        public string response { get; set; } = "";
    }

    public async ValueTask DisposeAsync()
    {
        if (objRef != null)
        {
            try { await JS.InvokeVoidAsync("inactivityTimer.dispose"); } catch {}
            objRef.Dispose();
        }
    }
}
