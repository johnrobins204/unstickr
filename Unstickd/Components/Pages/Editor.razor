@page "/editor/{StoryId:int}"
@using Blazored.TextEditor
@using Unstickd.Services
@using Unstickd.Models
@using Unstickd.Components.EditorPanels
@using Microsoft.EntityFrameworkCore
@using Serilog
@inject AppDbContext DbContext
@inject StoryState StoryState
@inject IJSRuntime JS
@implements IAsyncDisposable
@rendermode InteractiveServer

<PageTitle>Editor - @StoryState.Title</PageTitle>

<div class="flex flex-col gap-6">
    <!-- Pixel Card Editor Panel -->
    <div class="pixel-card p-0 overflow-hidden w-full max-w-4xl mx-auto">
        <!-- Collapsible Header -->
        <div class="border-b-4 border-[var(--border)] bg-[var(--card)]">
            <button @onclick="ToggleHeader" class="w-full px-6 py-3 flex items-center justify-between hover:bg-[var(--muted)] transition-colors">
                <div class="flex items-center gap-3">
                    <div class="text-2xl">‚úçÔ∏è</div>
                    <div class="text-left">
                        <div class="font-['Press_Start_2P'] text-[10px] text-[var(--primary)]">Story Details</div>
                        @if (!HeaderExpanded)
                        {
                            <div class="text-xs text-[var(--muted-foreground)] mt-1 truncate max-w-[200px]">@StoryState.Title</div>
                        }
                    </div>
                </div>
                <i data-lucide="@(HeaderExpanded ? "chevron-up" : "chevron-down")" class="size-5 text-[var(--muted-foreground)]"></i>
            </button>
            @if (HeaderExpanded)
            {
                <div class="px-6 pb-4 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-bold text-[var(--muted-foreground)] mb-1 block uppercase">Story Title</label>
                            <input type="text" class="w-full bg-[var(--background)] border-2 border-[var(--border)] px-3 py-2 outline-none focus:border-[var(--primary)] transition-colors" style="border-radius: var(--radius)" @bind="StoryState.Title" placeholder="Give your story a title..." />
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-[var(--muted-foreground)] mb-1 block uppercase">Quick Font Change</label>
                            <select @onchange="OnFontChange" class="w-full border-2 border-[var(--border)] bg-[var(--background)] px-2 py-2 text-xs outline-none focus:border-[var(--primary)]">
                                <optgroup label="üéÆ Game Styles">
                                    <option value="font-minecraft">üß± Minecraft UI (Silkscreen)</option>
                                    <option value="font-pixel">üëæ Modern Retro (Pixelify)</option>
                                    <option value="font-retro">üìü Terminal (VT323)</option>
                                </optgroup>
                                <optgroup label="üåü Inclusive & Clear">
                                    <option value="font-rounded">üìö School Standard (Lexend)</option>
                                    <option value="font-inclusive">üëÅÔ∏è Ultra-Clear (Atkinson)</option>
                                    <option value="font-dyslexia">üìñ Dyslexia Friendly (Comic Neue)</option>
                                </optgroup>
                                <optgroup label="‚úèÔ∏è Creative Styles">
                                    <option value="font-hand">‚úèÔ∏è Journal Style (Patrick Hand)</option>
                                    <option value="font-hero">üí• Action Hero (Luckiest Guy)</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-start gap-6 flex-wrap">
                        <div>
                            <label class="text-[10px] font-bold text-[var(--muted-foreground)] mb-1 block uppercase">Format</label>
                            <div class="flex items-center gap-2">
                                <button class="p-2 hover:bg-[var(--muted)] border-2 border-[var(--border)] transition-colors" style="border-radius: var(--radius)" title="Bold"><i data-lucide="bold" class="size-4"></i></button>
                                <button class="p-2 hover:bg-[var(--muted)] border-2 border-[var(--border)] transition-colors" style="border-radius: var(--radius)" title="Italic"><i data-lucide="italic" class="size-4"></i></button>
                                <button class="p-2 hover:bg-[var(--muted)] border-2 border-[var(--border)] transition-colors" style="border-radius: var(--radius)" title="Bullet List"><i data-lucide="list" class="size-4"></i></button>
                                <button class="p-2 hover:bg-[var(--muted)] border-2 border-[var(--border)] transition-colors" style="border-radius: var(--radius)" title="Numbered List"><i data-lucide="list-ordered" class="size-4"></i></button>
                            </div>
                        </div>
                        <div class="flex-1 min-w-[250px]">
                            <label class="text-[10px] font-bold text-[var(--muted-foreground)] mb-1 block uppercase">Story Type</label>
                            <div class="flex items-center gap-3">
                                <select class="flex-1 border-2 border-[var(--border)] bg-[var(--background)] px-2 py-2 text-xs outline-none focus:border-[var(--primary)]" @bind="StoryState.Genre">
                                    <option value="fantasy">üßô‚Äç‚ôÇÔ∏è Fantasy</option>
                                    <option value="adventure">üó∫Ô∏è Adventure</option>
                                    <option value="scifi">üöÄ Sci-Fi</option>
                                    <option value="mystery">üîç Mystery</option>
                                    <option value="horror">üëª Horror</option>
                                    <option value="comedy">üòÑ Comedy</option>
                                    <option value="fairy-tale">üè∞ Fairy Tale</option>
                                    <option value="superhero">ü¶∏ Superhero</option>
                                </select>
                                <select class="flex-1 border-2 border-[var(--border)] bg-[var(--background)] px-2 py-2 text-xs outline-none focus:border-[var(--primary)]">
                                    <option value="hero-journey">‚öîÔ∏è Hero's Journey</option>
                                    <option value="rags-to-riches">üíé Rags to Riches</option>
                                    <option value="quest">üó∫Ô∏è The Quest</option>
                                    <option value="overcoming-monster">üêâ Overcoming Monster</option>
                                    <option value="voyage-return">üö¢ Voyage & Return</option>
                                    <option value="comedy-arch">üé≠ Comedy</option>
                                    <option value="tragedy">üò¢ Tragedy</option>
                                    <option value="rebirth">üåü Rebirth</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        
        <!-- Editor Content Area -->
        <div class="flex flex-row relative">
            <!-- Watermark -->
            <div class="absolute bottom-10 right-10 pointer-events-none opacity-10 select-none z-0">
                <div class="text-8xl">üêâ</div>
            </div>
            <div class="flex-1 p-8">
                <BlazoredTextEditor @ref="@QuillHtml" Placeholder="Once upon a time..." Theme="snow" DebugLevel="error">
                    <ToolbarContent>
                        <span class="ql-formats">
                            <select class="ql-header">
                                <option selected=""></option>
                                <option value="1"></option>
                                <option value="2"></option>
                            </select>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-bold"></button>
                            <button class="ql-italic"></button>
                            <button class="ql-underline"></button>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-list" value="ordered"></button>
                            <button class="ql-list" value="bullet"></button>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-clean"></button>
                        </span>
                    </ToolbarContent>
                    <EditorContent>
                        @((MarkupString)InitialContent)
                    </EditorContent>
                </BlazoredTextEditor>
            </div>
            @if (IsNotebookOpen)
            {
                <div class="border-l-4 border-[var(--border)] bg-[var(--card)] flex flex-col min-w-[350px] max-w-[400px] transition-all">
                    <div class="flex items-center justify-between p-4 border-b-4 border-[var(--border)] bg-[var(--muted)]">
                        <h6 class="m-0 text-[var(--muted-foreground)] font-bold flex items-center gap-2"><i data-lucide="book" class="size-4"></i> Notebooks</h6>
                        <button type="button" class="px-2 py-1 bg-[var(--primary)] text-[var(--primary-foreground)] border-2 border-[var(--border)] hover:bg-opacity-80" style="border-radius: var(--radius)" @onclick="ToggleNotebook">
                            <i data-lucide="x" class="size-4"></i>
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto">
                        <NotebookPanel StoryId="StoryId" />
                    </div>
                </div>
            }
        </div>
        <div class="border-t-4 border-[var(--border)] bg-[var(--muted)] p-2 text-center text-[var(--muted-foreground)] text-xs">
            Continuous Flow &bull; @WordCount words
        </div>
    </div>
    <TutorPanel CurrentAccount="CurrentAccount" />
</div>

@code {
    [Parameter] public int StoryId { get; set; }

    BlazoredTextEditor? QuillHtml;
    string SaveStatus = "Ready";
    string InitialContent = "";
    int WordCount = 0;
    bool IsNotebookOpen = false;
    private bool HeaderExpanded = true;
    private DotNetObjectReference<Editor>? _objRef;
    private Account? CurrentAccount;

    private void ToggleHeader() => HeaderExpanded = !HeaderExpanded;
    private void ToggleNotebook() => IsNotebookOpen = !IsNotebookOpen;

    private async Task OnFontChange(ChangeEventArgs e)
    {
        var fontClass = e.Value?.ToString();
        if (!string.IsNullOrWhiteSpace(fontClass))
        {
            await JS.InvokeVoidAsync("setBodyClass", $"h-screen flex {fontClass}");
            StoryState.UpdateThemePreference(p => p.FontClass = fontClass);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var story = await DbContext.Stories
                .Include(s => s.Account)
                .ThenInclude(acc => acc != null ? acc.ActiveTheme : null)
                .Include(s => s.Pages) // Load pages for migration if needed
                .Include(s => s.EntityLinks)
                .Include(s => s.Account)
                .ThenInclude(a => a != null ? a.Notebooks : null)
                .ThenInclude(n => n != null ? n.Entities : null)
                .ThenInclude(e => e != null ? e.Entries : null)
                .FirstOrDefaultAsync(s => s.Id == StoryId);

            if (story != null)
            {
                CurrentAccount = story.Account;
                StoryState.Account = story.Account; // ADD THIS to support StoryState persistence

                // Load Theme Preferences
                if (!string.IsNullOrEmpty(story.Account?.ThemePreferenceJson))
                {
                    try 
                    {
                        var prefs = System.Text.Json.JsonSerializer.Deserialize<ThemePreference>(story.Account.ThemePreferenceJson);
                        if (prefs != null) 
                        {
                            StoryState.ThemePreference = prefs;
                            // Apply theme immediately if needed (usually handled by MainLayout binding to StoryState, but font might need JS)
                        }
                    }
                    catch { /* Ignore invalid JSON */ }
                }

                StoryState.Title = story.Title;
                StoryState.StoryId = story.Id;
                
                if (story.Account?.ActiveTheme != null)
                {
                    StoryState.CurrentTheme = story.Account.ActiveTheme;
                    StoryState.NotifyStateChanged(); 
                }
                
                // MIGRATION LOGIC: If Content is empty but Pages exist, combine them
                if (string.IsNullOrEmpty(story.Content) && story.Pages.Any())
                {
                    Log.Information("Migrating Pages to Continuous Content for Story {Id}", StoryId);
                    var combined = string.Join("", story.Pages.OrderBy(p => p.PageNumber).Select(p => p.Content));
                    story.Content = combined;
                    DbContext.Stories.Update(story);
                    await DbContext.SaveChangesAsync();
                }

                InitialContent = story.Content;
                StoryState.Content = story.Content;
                
                StoryState.Notebooks = story.Account?.Notebooks.ToList() ?? new List<Notebook>();
                StoryState.LinkedEntityIds = story.EntityLinks.Select(l => l.NotebookEntityId).ToHashSet();
                StoryState.Genre = story.Genre;
            }
        }
        catch (Exception ex)
        {
            Log.Error(ex, "Error loading story {StoryId}", StoryId);
            SaveStatus = "Error Loading";
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _objRef = DotNetObjectReference.Create(this);
            // 2000ms debounce as per requirements
            await JS.InvokeVoidAsync("editorJs.initAutoSave", _objRef, 2000); 
        }
    }

    [JSInvokable]
    public async Task TriggerAutoSave()
    {
        await InvokeAsync(async () => 
        {
            await SaveContent();
            StateHasChanged();
        });
    }

    private async Task SaveContent()
    {
        if (QuillHtml == null) return;
        
        SaveStatus = "Saving...";
        StateHasChanged();

        try 
        {
            string html = await QuillHtml.GetHTML();
            StoryState.Content = html;
            
            string text = await QuillHtml.GetText();
            WordCount = string.IsNullOrWhiteSpace(text) ? 0 : text.Split(new[] { ' ', '\n' }, StringSplitOptions.RemoveEmptyEntries).Length;

            var story = await DbContext.Stories.FindAsync(StoryId);
            
            if (story != null)
            {
                story.Content = html;
                story.Title = StoryState.Title ?? story.Title; // Sync Title
                story.Genre = StoryState.Genre ?? story.Genre; // Sync Genre
                story.LastModified = DateTime.Now;
                await DbContext.SaveChangesAsync();
                SaveStatus = "Saved"; 
            }
        }
        catch (Exception ex)
        {
            Log.Error(ex, "Error saving content");
            SaveStatus = "Not Saved!";
        }
    }

    public async ValueTask DisposeAsync()
    {
        _objRef?.Dispose();
    }
}
