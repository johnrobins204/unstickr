@page "/editor/{StoryId:int}"
@using Blazored.TextEditor
@using Unstickd.Services
@using Unstickd.Models
@using Unstickd.Components.EditorPanels
@using Microsoft.EntityFrameworkCore
@using Serilog
@inject AppDbContext DbContext
@inject StoryState StoryState
@inject IJSRuntime JS
@implements IAsyncDisposable
@rendermode InteractiveServer

<PageTitle>Editor - @StoryState.Title</PageTitle>

<div class="container-fluid h-100 p-0">
    <div class="d-flex flex-column h-100">
        <!-- Toolbar / Header -->
        <div class="bg-light border-bottom p-2 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
                <a href="/" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-house"></i> Home
                </a>
                <h5 class="m-0 text-truncate" style="max-width: 400px;">@StoryState.Title</h5>
                <a href="/onboarding/themes?StoryId=@StoryId" class="btn btn-sm btn-light text-muted ms-2" title="Change Theme">
                    <i class="bi bi-palette"></i>
                </a>
            </div>
            
            <div class="d-flex align-items-center">
                <span class="text-muted small me-2">@SaveStatus</span>
                <button class="btn btn-sm btn-outline-info me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#notebookOffcanvas" aria-controls="notebookOffcanvas">
                    <i class="bi bi-journal-bookmark-fill"></i> Notebooks
                </button>
                <button class="btn btn-primary btn-sm" @onclick="SaveContent">
                    <i class="bi bi-save"></i> Save
                </button>
            </div>
        </div>

        <!-- Editor Container: Continuous Column Scroll -->
        <div class="flex-grow-1 bg-light d-flex align-items-center justify-content-center overflow-hidden position-relative">
            <!-- Scroll Logic Left/Right -->
            <button class="btn btn-link nav-arrow start-0" @onclick="ScrollLeft">
                <i class="bi bi-chevron-left display-4 text-secondary opacity-50"></i>
            </button>
            
            <!-- Book Container -->
            <div id="book-viewport" class="book-viewport shadow-lg bg-white">
                <BlazoredTextEditor @ref="@QuillHtml" 
                                    Placeholder="Once upon a time..."
                                    Theme="snow"
                                    DebugLevel="error">
                    <ToolbarContent>
                        <span class="ql-formats">
                            <select class="ql-header">
                                <option selected=""></option>
                                <option value="1"></option>
                                <option value="2"></option>
                            </select>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-bold"></button>
                            <button class="ql-italic"></button>
                            <button class="ql-underline"></button>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-list" value="ordered"></button>
                            <button class="ql-list" value="bullet"></button>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-clean"></button>
                        </span>
                    </ToolbarContent>
                    <EditorContent>
                        @((MarkupString)InitialContent)
                    </EditorContent>
                </BlazoredTextEditor>
            </div>

            <button class="btn btn-link nav-arrow end-0" @onclick="ScrollRight">
                <i class="bi bi-chevron-right display-4 text-secondary opacity-50"></i>
            </button>
        </div>
        
        <div class="card-footer bg-light border-top p-1 text-center text-muted small">
            Continuous Flow &bull; @WordCount words
        </div>
    </div>
</div>

<!-- Offcanvas Notebooks -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="notebookOffcanvas" style="width: 400px;">
  <div class="offcanvas-header bg-light border-bottom py-2">
    <h5 class="offcanvas-title"><i class="bi bi-journal-bookmark me-2"></i>Notebooks</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body p-0 overflow-hidden">
    <NotebookPanel StoryId="StoryId" />
  </div>
</div>

<TutorPanel CurrentAccount="CurrentAccount" />

@code {
    [Parameter] public int StoryId { get; set; }

    BlazoredTextEditor? QuillHtml;
    string SaveStatus = "Ready";
    string InitialContent = "";
    int WordCount = 0;

    private Account? CurrentAccount;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var story = await DbContext.Stories
                .Include(s => s.Account).ThenInclude(acc => acc.ActiveTheme)
                .Include(s => s.Pages) // Load pages for migration if needed
                .Include(s => s.EntityLinks)
                .Include(s => s.Account).ThenInclude(a => a.Notebooks).ThenInclude(n => n.Entities).ThenInclude(e => e.Entries)
                .FirstOrDefaultAsync(s => s.Id == StoryId);

            if (story != null)
            {
                CurrentAccount = story.Account;
                StoryState.Title = story.Title;
                StoryState.StoryId = story.Id;
                
                if (story.Account?.ActiveTheme != null)
                {
                    StoryState.CurrentTheme = story.Account.ActiveTheme;
                    StoryState.NotifyStateChanged(); 
                }
                
                // MIGRATION LOGIC: If Content is empty but Pages exist, combine them
                if (string.IsNullOrEmpty(story.Content) && story.Pages.Any())
                {
                    Log.Information("Migrating Pages to Continuous Content for Story {Id}", StoryId);
                    var combined = string.Join("", story.Pages.OrderBy(p => p.PageNumber).Select(p => p.Content));
                    story.Content = combined;
                    // Do not save yet, wait for explicit save? Or save now?
                    // Let's save now to persist migration.
                    DbContext.Stories.Update(story);
                    await DbContext.SaveChangesAsync();
                }

                InitialContent = story.Content;
                StoryState.Content = story.Content;
                
                StoryState.Notebooks = story.Account?.Notebooks.ToList() ?? new List<Notebook>();
                StoryState.LinkedEntityIds = story.EntityLinks.Select(l => l.NotebookEntityId).ToHashSet();
            }
        }
        catch (Exception ex)
        {
            Log.Error(ex, "Error loading story {StoryId}", StoryId);
            SaveStatus = "Error Loading";
        }
    }

    private async Task ScrollRight()
    {
        // Simple JS scroll by viewport width
        await JS.InvokeVoidAsync("eval", "document.getElementById('book-viewport').scrollBy({ left: window.innerWidth * 0.8, behavior: 'smooth' })");
    }

    private async Task ScrollLeft()
    {
        await JS.InvokeVoidAsync("eval", "document.getElementById('book-viewport').scrollBy({ left: -(window.innerWidth * 0.8), behavior: 'smooth' })");
    }

    private async Task SaveContent()
    {
        if (QuillHtml == null) return;
        
        SaveStatus = "Saving...";
        try 
        {
            string html = await QuillHtml.GetHTML();
            StoryState.Content = html;
            
            // Basic word count
            string text = await QuillHtml.GetText();
            WordCount = string.IsNullOrWhiteSpace(text) ? 0 : text.Split(new[] { ' ', '\n' }, StringSplitOptions.RemoveEmptyEntries).Length;

            var story = await DbContext.Stories.FindAsync(StoryId);
            
            if (story != null)
            {
                story.Content = html;
                story.LastModified = DateTime.Now;
                await DbContext.SaveChangesAsync();
                SaveStatus = "Saved " + DateTime.Now.ToString("t");
            }
        }
        catch (Exception ex)
        {
            Log.Error(ex, "Error saving content");
            SaveStatus = "Error Saving";
        }
    }

    public async ValueTask DisposeAsync()
    {
    }
}
