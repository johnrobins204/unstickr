@page "/planner/{StoryId:int}"
@using Unstickd.Models
@using Unstickd.Services
@using Microsoft.EntityFrameworkCore
@using System.Text.Json
@inject AppDbContext DbContext
@inject StoryState StoryState
@inject ArchetypeService ArchetypeService
@inject IJSRuntime JS

<PageTitle>Planner - @StoryState.Title</PageTitle>

<div class="h-[calc(100vh-4rem)] flex flex-col md:flex-row overflow-hidden bg-[var(--background)]">
    <!-- Left: Archetype Selector & Stats -->
    <div class="w-full md:w-64 border-r border-[var(--border)] bg-[var(--card)] flex flex-col">
        <div class="p-4 border-b border-[var(--border)]">
            <h2 class="font-['Press_Start_2P'] text-xs text-[var(--primary)] mb-4">THE MAP ROOM</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-[var(--muted-foreground)] uppercase block mb-2">Story Shape</label>
                    <select class="w-full border-2 border-[var(--border)] bg-[var(--background)] p-2 text-sm outline-none focus:border-[var(--primary)]"
                            @bind="CurrentArchetypeId" 
                            @bind:after="OnArchetypeChanged">
                        @foreach (var arc in ArchetypeService.GetArchetypes())
                        {
                            <option value="@arc.Id">@arc.Name</option>
                        }
                    </select>
                </div>
                
                <div class="text-xs text-[var(--muted-foreground)] italic">
                    @CurrentArchetype?.Description
                </div>
            </div>
        </div>

        <div class="flex-1 p-4 overflow-y-auto">
            <div class="space-y-2">
                @if (CurrentArchetype != null)
                {
                    @foreach (var point in CurrentArchetype.Points)
                    {
                        var isCompleted = GetUserPoint(point.Id)?.IsCompleted ?? false;
                        <div class="flex items-center gap-2 p-2 hover:bg-[var(--muted)] cursor-pointer @(SelectedPointId == point.Id ? "bg-[var(--muted)] border-l-4 border-[var(--primary)]" : "")"
                             @onclick="() => SelectPoint(point.Id)">
                            <div class="size-4 rounded-full border border-[var(--foreground)] flex items-center justify-center text-[10px]">
                                @if (isCompleted) { <span class="text-green-500">âœ“</span> }
                                else { <span>@point.Id</span> }
                            </div>
                            <span class="text-sm truncate">@point.Label</span>
                        </div>
                    }
                }
            </div>
        </div>
    </div>

    <!-- Center: The Map (SVG) -->
    <div class="flex-1 relative bg-[var(--background)] overflow-hidden flex flex-col">
        <div class="absolute inset-0 opacity-10 pointer-events-none" 
             style="background-image: radial-gradient(#888 1px, transparent 1px); background-size: 20px 20px;">
        </div>

        <div class="flex-1 flex items-center justify-center p-8 overflow-auto">
            @if (CurrentArchetype != null)
            {
                <div class="relative w-full max-w-4xl aspect-[2/1]">
                    <svg viewBox="0 0 800 400" class="w-full h-full drop-shadow-xl">
                        <!-- Path -->
                        <path d="@CurrentArchetype.Path" 
                              fill="none" 
                              stroke="var(--foreground)" 
                              stroke-width="4" 
                              stroke-linecap="round" 
                              class="opacity-80" />

                        <!-- Points -->
                        @foreach (var point in CurrentArchetype.Points)
                        {
                            var isSelected = SelectedPointId == point.Id;
                            var userPoint = GetUserPoint(point.Id);
                            var hasData = !string.IsNullOrWhiteSpace(userPoint?.Notes);

                            <g transform="translate(@point.X, @point.Y)" 
                               class="cursor-pointer transition-transform duration-200 hover:scale-110 @(isSelected ? "scale-125" : "")"
                               @onclick="() => SelectPoint(point.Id)">
                                
                                <!-- Halo for selection -->
                                @if (isSelected) 
                                {
                                    <circle r="20" fill="var(--primary)" opacity="0.2" class="animate-pulse" />
                                }

                                <!-- Main Dot -->
                                <circle r="12" 
                                        fill="@(hasData ? "var(--primary)" : "var(--background)")" 
                                        stroke="var(--foreground)" 
                                        stroke-width="3" />
                                
                                <text y="5" text-anchor="middle" font-size="10" font-weight="bold" fill="@(hasData ? "var(--background)" : "var(--foreground)")" class="pointer-events-none">
                                    @point.Id
                                </text>

                                <!-- Label -->
                                <text y="-20" 
                                      text-anchor="middle" 
                                      class="text-[10px] uppercase font-bold fill-[var(--muted-foreground)] pointer-events-none select-none"
                                      style="text-shadow: 0 1px 2px var(--background);">
                                    @point.Label
                                </text>
                            </g>
                        }
                    </svg>
                </div>
            }
        </div>
    </div>

    <!-- Right: Point Editor -->
    @if (SelectedPointDefinition != null)
    {
        <div class="w-full md:w-80 border-l border-[var(--border)] bg-[var(--card)] flex flex-col shadow-2xl relative z-20">
            <div class="p-4 border-b border-[var(--border)] flex justify-between items-center bg-[var(--muted)]">
                <span class="font-bold text-sm">POINT @SelectedPointDefinition.Id: @SelectedPointDefinition.Label.ToUpper()</span>
                <button @onclick="() => SelectPoint(-1)" class="text-[var(--muted-foreground)] hover:text-[var(--foreground)]">âœ•</button>
            </div>

            <div class="flex-1 p-6 overflow-y-auto space-y-6">
                <!-- The Spark / Prompt -->
                <div class="bg-[var(--background)] p-4 border-2 border-[var(--primary)] rounded-lg relative">
                    <div class="absolute -top-3 left-3 bg-[var(--background)] px-2 text-[10px] font-bold text-[var(--primary)] uppercase">
                        The Spark
                    </div>
                    <p class="text-sm font-medium italic">
                        @SelectedPointDefinition.Prompt
                    </p>
                </div>

                <!-- User Input -->
                <div class="space-y-2">
                    <label class="text-xs font-bold uppercase text-[var(--muted-foreground)]">Your Plan</label>
                    <textarea class="w-full h-40 bg-[var(--background)] border-2 border-[var(--border)] p-3 text-sm outline-none focus:border-[var(--primary)] resize-none rounded-md"
                              @bind="CurrentNoteText"
                              @bind:event="oninput"
                              placeholder="What happens here?"></textarea>
                </div>

                <!-- Literary Examples -->
                @if (SelectedPointDefinition.Examples != null && SelectedPointDefinition.Examples.Any())
                {
                   <div class="mt-4 border border-[var(--border)] rounded-md overflow-hidden">
                       <button @onclick="ToggleExamples" class="w-full px-4 py-2 bg-[var(--muted)] hover:bg-[var(--border)] text-left text-xs font-bold uppercase flex justify-between items-center transition-colors">
                           <span>Literary Inspiration</span>
                           <span>@(ShowExamples ? "âˆ’" : "+")</span>
                       </button>
                       
                       @if (ShowExamples)
                       {
                           <div class="bg-[var(--card)] p-4 space-y-4">
                                @foreach (var ex in SelectedPointDefinition.Examples)
                                {
                                    <div class="text-sm">
                                        <p class="font-bold text-[var(--primary)] mb-1">@ex.Title</p>
                                        <p class="text-[var(--muted-foreground)] italic leading-relaxed">"@ex.Content"</p>
                                    </div>
                                }
                           </div>
                       }
                   </div>
                }

                <!-- Helper Status -->
                <div class="text-xs text-[var(--muted-foreground)] flex items-center gap-2">
                    @if (SaveStatus == "Saving...") 
                    {
                        <span class="animate-pulse">ðŸ’¾ Saving...</span>
                    }
                    else if (SaveStatus == "Saved")
                    {
                        <span class="text-green-500">âœ“ Saved</span>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int StoryId { get; set; }

    private ArchetypeDefinition? CurrentArchetype;
    private int SelectedPointId = -1;
    private StoryPlotPoint? SelectedPointDefinition => CurrentArchetype?.Points.FirstOrDefault(p => p.Id == SelectedPointId);
    
    private string CurrentArchetypeId
    {
        get => StoryState.CurrentPlan.ArchetypeId;
        set => StoryState.CurrentPlan.ArchetypeId = value;
    }

    private string CurrentNoteText
    {
        get
        {
            if (SelectedPointId == -1) return "";
            return GetUserPoint(SelectedPointId)?.Notes ?? "";
        }
        set
        {
            if (SelectedPointId != -1)
            {
                UpdateUserPoint(SelectedPointId, value);
            }
        }
    }

    private string SaveStatus = "";
    private System.Timers.Timer? _debounceTimer;
    
    private bool ShowExamples = false;
    private void ToggleExamples() => ShowExamples = !ShowExamples;

    protected override async Task OnInitializedAsync()
    {
        // Load Story Data
        var story = await DbContext.Stories.FindAsync(StoryId);
        if (story != null)
        {
            StoryState.StoryId = story.Id;
            StoryState.Title = story.Title;
            StoryState.Content = story.Content;
            StoryState.Genre = story.Genre;

            // Deserialize Plans
            if (!string.IsNullOrEmpty(story.Metadata) && story.Metadata != "{}")
            {
                try 
                {
                    var plan = JsonSerializer.Deserialize<StoryPlanData>(story.Metadata);
                    if (plan != null) StoryState.CurrentPlan = plan;
                }
                catch { /* Ignore invalid JSON */ }
            }

            LoadArchetype();
        }
    }

    private void LoadArchetype()
    {
        CurrentArchetype = ArchetypeService.GetArchetypes().FirstOrDefault(a => a.Id == CurrentArchetypeId) 
                           ?? ArchetypeService.GetArchetypes().First();
        
        // Ensure User PlotPoints exist for this archetype
        foreach (var def in CurrentArchetype.Points)
        {
            if (!StoryState.CurrentPlan.PlotPoints.Any(p => p.Id == def.Id))
            {
                StoryState.CurrentPlan.PlotPoints.Add(new StoryPlotPoint
                {
                    Id = def.Id,
                    Label = def.Label,
                    Prompt = def.Prompt,
                    X = def.X,
                    Y = def.Y
                });
            }
        }
        
        // Auto-select first point if none selected
        if (SelectedPointId == -1 && CurrentArchetype.Points.Any())
        {
            SelectPoint(1);
        }
    }

    private void OnArchetypeChanged()
    {
        LoadArchetype();
        DebounceSave();
    }

    private void SelectPoint(int id)
    {
        SelectedPointId = id;
    }

    private StoryPlotPoint? GetUserPoint(int id)
    {
        return StoryState.CurrentPlan.PlotPoints.FirstOrDefault(p => p.Id == id);
    }

    private void UpdateUserPoint(int id, string notes)
    {
        var point = GetUserPoint(id);
        if (point != null)
        {
            point.Notes = notes;
            point.IsCompleted = !string.IsNullOrWhiteSpace(notes);
            DebounceSave();
        }
    }

    private void DebounceSave()
    {
        SaveStatus = "Saving...";
        _debounceTimer?.Stop();
        _debounceTimer = new System.Timers.Timer(1000);
        _debounceTimer.AutoReset = false;
        _debounceTimer.Elapsed += async (s, e) => await InvokeAsync(SaveData);
        _debounceTimer.Start();
    }

    private async Task SaveData()
    {
        try
        {
            using var scope = DbContext.Database.BeginTransaction(); // Ensure db context is used correctly or create new scope if needed
            // Actually, we are using scoped DbContext injection so check if it's still alive.
            // Better to fetch fresh just in case or rely on injected instance if it's InteractiveServer component (stateful).
            
            var story = await DbContext.Stories.FindAsync(StoryId);
            if (story != null)
            {
                story.Metadata = JsonSerializer.Serialize(StoryState.CurrentPlan);
                story.Genre = StoryState.Genre; // Keep synced
                story.LastModified = DateTime.Now;
                
                await DbContext.SaveChangesAsync();
                await InvokeAsync(() => 
                {
                    SaveStatus = "Saved";
                    StateHasChanged();
                });
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Save Error: {ex.Message}");
            await InvokeAsync(() => SaveStatus = "Error!");
        }
    }
}
