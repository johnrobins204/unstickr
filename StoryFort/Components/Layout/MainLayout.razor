@inherits LayoutComponentBase
@using StoryFort.Services
@inject StoryState StoryState
@inject IJSRuntime JS
@implements IDisposable

<div class="h-screen flex @(StoryState.ThemePreference.FontClass) antialiased relative">
    <!-- Pixel grid background -->
    <div class="pixel-grid"></div>
    <!-- Sidebar -->
    <aside class="w-56 min-h-0 flex-shrink-0 bg-[var(--sidebar)] text-[var(--sidebar-foreground)] border-r-4 border-[var(--sidebar-border)] flex flex-col z-10 overflow-y-auto">
        <NavMenu />
    </aside>
    <!-- Main content with wireframe header -->
    <main class="flex-1 flex flex-col relative z-10 overflow-hidden p-0">
        <!-- Wireframe Header & Breadcrumbs -->
        <header class="border-b-4 border-[var(--border)] bg-[var(--card)] px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <button @onclick="NavigateHome" class="flex items-center gap-2 px-3 py-1 bg-[var(--muted)] border-2 border-[var(--border)] hover:bg-opacity-80" style="border-radius: var(--radius)">
                    <i data-lucide="home" class="size-4"></i>
                    <span class="text-sm">Home</span>
                </button>
                <div class="text-sm text-[var(--muted-foreground)] flex items-center gap-2">
                    <span>/</span>
                    <span>@BreadcrumbParent</span>
                    @if (!string.IsNullOrEmpty(BreadcrumbChild))
                    {
                        <span>/</span>
                        <span>@BreadcrumbChild</span>
                    }
                </div>
            </div>
            <div class="text-right">
                <div class="text-[10px] text-[var(--muted-foreground)] uppercase tracking-widest font-bold">The Writer's Stronghold</div>
            </div>
        </header>
        <div class="flex-1 flex flex-col p-6 md:p-8 overflow-y-auto">
            @Body
        </div>
    </main>
</div>



<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">??</span>
</div>

@code {
    protected override void OnInitialized()
    {
        StoryState.OnChange += StateHasChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && StoryState.ThemePreference != null)
        {
            // Re-apply persisted CSS variables on hard refresh
            var p = StoryState.ThemePreference;
            if (!string.IsNullOrEmpty(p.Background)) await JS.InvokeVoidAsync("setCssVariable", "--background", p.Background);
            if (!string.IsNullOrEmpty(p.Foreground)) await JS.InvokeVoidAsync("setCssVariable", "--foreground", p.Foreground);
            if (!string.IsNullOrEmpty(p.Primary)) await JS.InvokeVoidAsync("setCssVariable", "--primary", p.Primary);
            if (!string.IsNullOrEmpty(p.Card)) await JS.InvokeVoidAsync("setCssVariable", "--card", p.Card);
            if (!string.IsNullOrEmpty(p.Radius)) await JS.InvokeVoidAsync("setCssVariable", "--radius", p.Radius);
            if (p.FontSize > 0) await JS.InvokeVoidAsync("setCssVariable", "--font-size", $"{p.FontSize}px");
        }
    }

    public void Dispose()
    {
        StoryState.OnChange -= StateHasChanged;
    }

    // Breadcrumbs Logic
    [Inject] NavigationManager Navigation { get; set; } = default!;
    
    private string BreadcrumbParent => Navigation.Uri.Contains("editor") ? "Writer's Room" : 
                                      Navigation.Uri.Contains("notebooks") ? "Archives" :
                                      Navigation.Uri.Contains("design") ? "Creative Studio" : 
                                      Navigation.Uri.Contains("settings") ? "Admin Center" : "Home";
    
    private string BreadcrumbChild => ""; 

    private void NavigateHome()
    {
        Navigation.NavigateTo("/");
    }
}

