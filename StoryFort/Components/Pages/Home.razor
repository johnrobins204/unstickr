@page "/home"
@using Microsoft.EntityFrameworkCore
@using StoryFort.Models
@using StoryFort.Components.Layout
@using StoryFort.Data
@using StoryFort.Services
@using Serilog
@inject AppDbContext DbContext
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject StoryState StoryState
@inject ReaderHtmlHelper ReaderHtmlHelper
@rendermode InteractiveServer

<PageTitle>StoryFort - My Bookcase</PageTitle>

@if (ShowAgeGate)
{
    @* --- ONBOARDING / AGE GATE --- *@
    <div class="d-flex flex-column align-items-center justify-content-center vh-100 text-center">
        <h1 class="display-3 fw-bold mb-4">New Adventure</h1>
        <p class="lead mb-5">To find the right world for you, we need a date.</p>

        <div class="card p-4 shadow-sm" style="max-width: 400px; width: 100%;">
            <div class="mb-3">
                <label for="dob" class="form-label">When were you born?</label>
                <input type="date" id="dob" class="form-control text-center" @bind="DateOfBirth" />
            </div>
            
            @if (ShowAgeError)
            {
                <div class="alert alert-warning">
                    Please enter a valid date.
                </div>
            }

            <div class="d-grid gap-2">
                <button class="btn btn-primary btn-lg" @onclick="HandleEnter" disabled="@IsButtonDisabled">
                    Start Writing
                </button>
                @if (HasStories)
                {
                    <button class="btn btn-outline-secondary" @onclick="() => ShowAgeGate = false">
                        Cancel
                    </button>
                }
            </div>
        </div>
        
        <div class="mt-4 text-muted small">
            <p>We use this to suggest themes. It is not saved.</p>
        </div>
    </div>
}
else
{
    @* --- DASHBOARD --- *@
    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h1 class="display-5 fw-bold">My Bookcase</h1>
                <p class="text-muted">Welcome back, writer!</p>
            </div>
            <div class="d-flex gap-2">
                <a href="/settings" class="btn btn-outline-secondary btn-lg shadow-sm" title="Settings">
                    <i class="bi bi-gear"></i>
                </a>
                <button class="btn btn-success btn-lg shadow-sm" @onclick="() => ShowAgeGate = true">
                    <i class="bi bi-plus-circle me-2"></i>New Story
                </button>
            </div>
        </div>

        @if (Stories == null)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else if (!Stories.Any())
        {
            <div class="text-center py-5 bg-light rounded-3">
                <h3 class="text-muted mb-3">Your bookcase is empty.</h3>
                <p class="mb-4">Time to start your first adventure!</p>
                <button class="btn btn-primary btn-lg" @onclick="() => ShowAgeGate = true">
                    Create a Story
                </button>
            </div>
        }
        else
        {
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                @foreach (var story in Stories)
                {
                    <div class="col">
                        <div class="card h-100 shadow-sm border-0 story-card">
                            <div class="card-header border-0 d-flex justify-content-between align-items-center bg-secondary text-white">
                                <small class="fw-bold">Story</small>
                                <button class="btn btn-link text-white p-0" title="Delete" @onclick="() => DeleteStory(story)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            <div class="card-body d-flex flex-column" @onclick="() => OpenStory(story)" style="cursor: pointer;">
                                <h5 class="card-title fw-bold text-dark">@story.Title</h5>
                                <p class="card-text text-muted small flex-grow-1">
                                    Last edited: @story.LastModified.ToString("MMM dd, yyyy")
                                </p>
                            </div>
                            <div class="card-footer bg-white border-0 text-end">
                                <div class="d-flex justify-content-end gap-2">
                                                    <button class="btn btn-outline-primary btn-sm" @onclick="() => OpenStory(story)">
                                                        Open Book
                                                    </button>
                                                    <button id="read-btn-@story.Id" class="btn btn-secondary btn-sm" @onclick='() => StartGhostAndRead(story.Id, "read-btn-" + story.Id)'>
                                                        Read
                                                    </button>
                                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
    
    <style>
        .story-card { transition: transform 0.2s; }
        .story-card:hover { transform: translateY(-5px); }
    </style>

    @if (ShowReader)
    {
        <ReaderModal StoryId="@ReaderStoryId" Content="@ReaderContent" OnClose="CloseReader" />
    }
}

@code {
    // Dashboard Data
    private List<Story>? Stories;
    private bool HasStories => Stories != null && Stories.Any();

    // Onboarding State
    private bool ShowAgeGate = false;
    private DateOnly? DateOfBirth;
    private bool ShowAgeError = false;
    private bool IsButtonDisabled => !DateOfBirth.HasValue;

        // Reader modal state
        private bool ShowReader = false;
        private int ReaderStoryId = 0;
        private string ReaderContent = string.Empty;

        private async Task OpenReader(Story story)
        {
            // Load full story content (prefer Story.Content, fall back to concatenated pages)
            var full = await DbContext.Stories
                .Include(s => s.Pages)
                .FirstOrDefaultAsync(s => s.Id == story.Id);

            if (full == null)
            {
                return;
            }

            string raw = string.Empty;
            if (!string.IsNullOrWhiteSpace(full.Content))
            {
                raw = full.Content;
            }
            else
            {
                raw = string.Join("\n", full.Pages.OrderBy(p => p.PageNumber).Select(p => p.Content));
            }

            // Parse pinned sentence IDs from story.Metadata if present
            var pinnedIds = new List<string>();
            try
            {
                if (!string.IsNullOrWhiteSpace(full.Metadata))
                {
                    using var doc = System.Text.Json.JsonDocument.Parse(full.Metadata);
                    if (doc.RootElement.TryGetProperty("pinnedSentences", out var pinnedElem) && pinnedElem.ValueKind == System.Text.Json.JsonValueKind.Object)
                    {
                        foreach (var prop in pinnedElem.EnumerateObject())
                        {
                            pinnedIds.Add(prop.Name);
                        }
                    }
                }
            }
            catch { /* ignore malformed metadata */ }

            // Pre-wrap HTML with sentence spans and include pinned markers
            ReaderContent = ReaderHtmlHelper.WrapSentences(raw, pinnedIds);

            ReaderStoryId = full.Id;
            ShowReader = true;
            await JS.InvokeVoidAsync("reader.init");
        }

        private Task CloseReader()
        {
            ShowReader = false;
            ReaderContent = string.Empty;
            ReaderStoryId = 0;
            return Task.CompletedTask;
        }

        // Ghost animation: start from element then callback into OnGhostAnimationComplete
        private DotNetObjectReference<object>? ghostDotNetRef;

        private async Task StartGhostAndRead(int storyId, string elementId)
        {
            // Create a dotnet reference to receive callback
            ghostDotNetRef?.Dispose();
            ghostDotNetRef = DotNetObjectReference.Create<object>(this);
            await JS.InvokeVoidAsync("reader.animateGhostFromElement", elementId, storyId, ghostDotNetRef);
        }

        [JSInvokable]
        public async Task OnGhostAnimationComplete(int storyId)
        {
            // Find story and open reader (reuse existing OpenReader behavior)
            var story = await DbContext.Stories.FindAsync(storyId);
            if (story != null)
            {
                await OpenReader(story);
            }

            ghostDotNetRef?.Dispose();
            ghostDotNetRef = null;
            StateHasChanged();
        }

    protected override async Task OnInitializedAsync()
    {
        await LoadStories();
        
        // If no stories, default to Age Gate Mode
        if (!Stories!.Any())
        {
            ShowAgeGate = true;
        }
    }

    private async Task LoadStories()
    {
        Stories = await DbContext.Stories
            .OrderByDescending(s => s.LastModified)
            .ToListAsync();
    }

    private async Task HandleEnter()
    {
        if (!DateOfBirth.HasValue || DateOfBirth.Value > DateOnly.FromDateTime(DateTime.Now))
        {
            ShowAgeError = true;
            return;
        }
        
        var age = DateTime.Now.Year - DateOfBirth.Value.Year;
        if (DateOfBirth.Value > DateOnly.FromDateTime(DateTime.Now.AddYears(-age))) age--;
        
        // --- NEW WORKFLOW: Create Story Directly ---
        try 
        {
            await CreateStory(age);
        }
        catch (Exception ex)
        {
            Log.Error(ex, "Failed to create story during onboarding");
            // In a real app, show error UI
        }
    }

    private async Task CreateStory(int userAge)
    {
         // 1. Get a Default Theme (First one available, or specific "Standard" logic)
         var defaultTheme = await DbContext.Themes.FirstOrDefaultAsync();
         if (defaultTheme == null)
         {
             // Fallback if no themes seeded? Should not happen in prod.
             // We can proceed with null if we make property nullable, but let's assume one exists.
             // Or throw
             throw new Exception("No themes available in database.");
         }

        // 2. Ensure Account exists (For single user mode, we use ID 1)
        var accountId = 1;
        var hasNotebooks = await DbContext.Notebooks.AnyAsync(n => n.AccountId == accountId);
        if (!hasNotebooks)
        {
            DbContext.Notebooks.AddRange(
                new Notebook { Name = "Characters", Icon = "bi-person", AccountId = accountId },
                new Notebook { Name = "Places", Icon = "bi-geo-alt", AccountId = accountId },
                new Notebook { Name = "Spells", Icon = "bi-magic", AccountId = accountId }
            );
            await DbContext.SaveChangesAsync();
        }

        // 3. Create Story
        var initialContent = $"<p></p>";
        var newStory = new Story
        {
            Title = "Untitled Story",
            AccountId = accountId,
            Created = DateTime.Now,
            LastModified = DateTime.Now,
            Pages = new List<StoryPage>
            {
                new StoryPage 
                { 
                    PageNumber = 1,
                    Content = initialContent 
                }
            }
        };

        DbContext.Stories.Add(newStory);
        await DbContext.SaveChangesAsync();
        Log.Information("Created new Story Id: {StoryId} via Quick Onboarding", newStory.Id);

        // 4. Update In-Memory State
        StoryState.Title = newStory.Title;
        StoryState.Content = initialContent;    
        
        // 5. Navigate to Editor
        Nav.NavigateTo($"/editor/{newStory.Id}");
    }

    private void OpenStory(Story story)
    {
        Nav.NavigateTo($"/editor/{story.Id}");
    }

    private async Task DeleteStory(Story story)
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", $"Are you sure you want to delete '{story.Title}'?");
        if (!confirmed) return;

        DbContext.Stories.Remove(story);
        await DbContext.SaveChangesAsync();
        await LoadStories(); // Refresh list
    }
}

