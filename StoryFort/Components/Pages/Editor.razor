@page "/editor/{StoryId:int}"
@using Blazored.TextEditor
@using StoryFort.Services
@using StoryFort.Models
@using StoryFort.Components.EditorPanels
@using Microsoft.EntityFrameworkCore
@using Serilog
@inject IJSRuntime JS
@implements IAsyncDisposable
@rendermode InteractiveServer

<PageTitle>Editor - @StoryContext.Title</PageTitle>

<div class="flex flex-col gap-6">
    <!-- Pixel Card Editor Panel -->
    <div class="pixel-card p-0 overflow-hidden w-full max-w-4xl mx-auto">
        <!-- Collapsible Header -->
        <div class="border-b-4 border-[var(--border)] bg-[var(--card)]">
            <button @onclick="ToggleHeader" class="w-full px-6 py-3 flex items-center justify-between hover:bg-[var(--muted)] transition-colors">
                <div class="flex items-center gap-3">
                    <div class="text-2xl">âœï¸</div>
                    <div class="text-left">
                        <div class="font-['Press_Start_2P'] text-[10px] text-[var(--primary)]">Story Details</div>
                        @if (!HeaderExpanded)
                        {
                            <div class="text-xs text-[var(--muted-foreground)] mt-1 truncate max-w-[200px]">@StoryContext.Title</div>
                        }
                    </div>
                </div>
                <i data-lucide="@(HeaderExpanded ? "chevron-up" : "chevron-down")" class="size-5 text-[var(--muted-foreground)]"></i>
            </button>
            @if (HeaderExpanded)
            {
                <div class="px-6 pb-4 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-bold text-[var(--muted-foreground)] mb-1 block uppercase">Story Title</label>
                            <input type="text" class="w-full bg-[var(--background)] border-2 border-[var(--border)] px-3 py-2 outline-none focus:border-[var(--primary)] transition-colors" style="border-radius: var(--radius)" @bind="StoryContext.Title" placeholder="Give your story a title..." />
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-[var(--muted-foreground)] mb-1 block uppercase">Quick Font Change</label>
                            <select @onchange="OnFontChange" class="w-full border-2 border-[var(--border)] bg-[var(--background)] px-2 py-2 text-xs outline-none focus:border-[var(--primary)]">
                                <optgroup label="ğŸ® Game Styles">
                                    <option value="font-minecraft">ğŸ§± Minecraft UI (Silkscreen)</option>
                                    <option value="font-pixel">ğŸ‘¾ Modern Retro (Pixelify)</option>
                                    <option value="font-retro">ğŸ“Ÿ Terminal (VT323)</option>
                                </optgroup>
                                <optgroup label="ğŸŒŸ Inclusive & Clear">
                                    <option value="font-rounded">ğŸ“š School Standard (Lexend)</option>
                                    <option value="font-inclusive">ğŸ‘ï¸ Ultra-Clear (Atkinson)</option>
                                    <option value="font-dyslexia">ğŸ“– Dyslexia Friendly (Comic Neue)</option>
                                </optgroup>
                                <optgroup label="âœï¸ Creative Styles">
                                    <option value="font-hand">âœï¸ Journal Style (Patrick Hand)</option>
                                    <option value="font-hero">ğŸ’¥ Action Hero (Luckiest Guy)</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-start gap-6 flex-wrap">
                        <div>
                            <label class="text-[10px] font-bold text-[var(--muted-foreground)] mb-1 block uppercase">Format</label>
                            <div class="flex items-center gap-2">
                                <button class="p-2 hover:bg-[var(--muted)] border-2 border-[var(--border)] transition-colors" style="border-radius: var(--radius)" title="Bold"><i data-lucide="bold" class="size-4"></i></button>
                                <button class="p-2 hover:bg-[var(--muted)] border-2 border-[var(--border)] transition-colors" style="border-radius: var(--radius)" title="Italic"><i data-lucide="italic" class="size-4"></i></button>
                                <button class="p-2 hover:bg-[var(--muted)] border-2 border-[var(--border)] transition-colors" style="border-radius: var(--radius)" title="Bullet List"><i data-lucide="list" class="size-4"></i></button>
                                <button class="p-2 hover:bg-[var(--muted)] border-2 border-[var(--border)] transition-colors" style="border-radius: var(--radius)" title="Numbered List"><i data-lucide="list-ordered" class="size-4"></i></button>
                            </div>
                        </div>
                        <div class="flex-1 min-w-[250px]">
                            <label class="text-[10px] font-bold text-[var(--muted-foreground)] mb-1 block uppercase">Story Type</label>
                            <div class="flex items-center gap-3">
                                <select class="flex-1 border-2 border-[var(--border)] bg-[var(--background)] px-2 py-2 text-xs outline-none focus:border-[var(--primary)]" @bind="StoryContext.Genre">
                                    <option value="fantasy">ğŸ§™â€â™‚ï¸ Fantasy</option>
                                    <option value="adventure">ğŸ—ºï¸ Adventure</option>
                                    <option value="scifi">ğŸš€ Sci-Fi</option>
                                    <option value="mystery">ğŸ” Mystery</option>
                                    <option value="horror">ğŸ‘» Horror</option>
                                    <option value="comedy">ğŸ˜„ Comedy</option>
                                    <option value="fairy-tale">ğŸ° Fairy Tale</option>
                                    <option value="superhero">ğŸ¦¸ Superhero</option>
                                </select>
                                <select class="flex-1 border-2 border-[var(--border)] bg-[var(--background)] px-2 py-2 text-xs outline-none focus:border-[var(--primary)]">
                                    <option value="hero-journey">âš”ï¸ Hero's Journey</option>
                                    <option value="rags-to-riches">ğŸ’ Rags to Riches</option>
                                    <option value="quest">ğŸ—ºï¸ The Quest</option>
                                    <option value="overcoming-monster">ğŸ‰ Overcoming Monster</option>
                                    <option value="voyage-return">ğŸš¢ Voyage & Return</option>
                                    <option value="comedy-arch">ğŸ­ Comedy</option>
                                    <option value="tragedy">ğŸ˜¢ Tragedy</option>
                                    <option value="rebirth">ğŸŒŸ Rebirth</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        
        <!-- Editor Content Area -->
        <div class="flex flex-row relative">
            <!-- Watermark -->
            <div class="absolute bottom-10 right-10 pointer-events-none opacity-10 select-none z-0">
                <div class="text-8xl">ğŸ‰</div>
            </div>
            <div class="flex-1 p-8">
                <BlazoredTextEditor @ref="@QuillHtml" Placeholder="Once upon a time..." Theme="snow" DebugLevel="error">
                    <ToolbarContent>
                        <span class="ql-formats">
                            <select class="ql-header">
                                <option selected=""></option>
                                <option value="1"></option>
                                <option value="2"></option>
                            </select>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-bold"></button>
                            <button class="ql-italic"></button>
                            <button class="ql-underline"></button>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-list" value="ordered"></button>
                            <button class="ql-list" value="bullet"></button>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-clean"></button>
                        </span>
                    </ToolbarContent>
                    <EditorContent>
                        @((MarkupString)InitialContent)
                    </EditorContent>
                </BlazoredTextEditor>
            </div>
            @if (IsNotebookOpen)
            {
                <div class="border-l-4 border-[var(--border)] bg-[var(--card)] flex flex-col min-w-[350px] max-w-[400px] transition-all">
                    <div class="flex items-center justify-between p-4 border-b-4 border-[var(--border)] bg-[var(--muted)]">
                        <h6 class="m-0 text-[var(--muted-foreground)] font-bold flex items-center gap-2"><i data-lucide="book" class="size-4"></i> Notebooks</h6>
                        <button type="button" class="px-2 py-1 bg-[var(--primary)] text-[var(--primary-foreground)] border-2 border-[var(--border)] hover:bg-opacity-80" style="border-radius: var(--radius)" @onclick="ToggleNotebook">
                            <i data-lucide="x" class="size-4"></i>
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto">
                        <NotebookPanel StoryId="StoryId" />
                    </div>
                </div>
            }
        </div>
        <div class="border-t-4 border-[var(--border)] bg-[var(--muted)] p-2 text-center text-[var(--muted-foreground)] text-xs">
            Continuous Flow &bull; @WordCount words &bull; @SaveStatus
        </div>
    </div>
    <TutorPanel CurrentAccount="CurrentAccount" />
</div>

@* Code moved to Editor.razor.cs partial class *@

