@page "/planner/{StoryId:int}"
@rendermode InteractiveServer
@using StoryFort.Models
@using StoryFort.Services
@using Microsoft.EntityFrameworkCore
@using System.Text.Json
@inject AppDbContext DbContext
@inject IJSRuntime JS

<PageTitle>Planner - @StoryContext.Title</PageTitle>

<div class="h-[calc(100vh-4rem)] flex flex-col md:flex-row overflow-hidden bg-[var(--background)]">
    <!-- Left: Archetype Selector & Stats -->
    <div class="w-full md:w-64 border-r border-[var(--border)] bg-[var(--card)] flex flex-col">
        <div class="p-4 border-b border-[var(--border)]">
            <h2 class="font-['Press_Start_2P'] text-xs text-[var(--primary)] mb-4">THE MAP ROOM</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-[var(--muted-foreground)] uppercase block mb-2">Story Shape</label>
                    <select class="w-full border-2 border-[var(--border)] bg-[var(--background)] p-2 text-sm outline-none focus:border-[var(--primary)]"
                            value="@CurrentArchetypeId"
                            @onchange="OnArchetypeSelectChanged">
                        @foreach (var group in AllArchetypes.GroupBy(a => a.PlaceOfOrigin).OrderBy(g => g.Key))
                        {
                            <optgroup label="@group.Key">
                                @foreach (var arc in group.OrderBy(a => a.Name))
                                {
                                    <option value="@arc.Id">@arc.Name</option>
                                }
                            </optgroup>
                        }
                    </select>
                </div>
                
                <div class="text-xs text-[var(--muted-foreground)] italic">
                    @CurrentArchetype?.Description
                </div>
            </div>
        </div>

        <div class="flex-1 p-4 overflow-y-auto">
            <div class="space-y-2">
                @if (CurrentArchetype != null)
                {
                    @foreach (var point in CurrentArchetype.Points)
                    {
                        var isCompleted = GetUserPoint(point.Id)?.IsCompleted ?? false;
                        <div class="flex items-center gap-2 p-2 hover:bg-[var(--muted)] cursor-pointer @(SelectedPointId == point.Id ? "bg-[var(--muted)] border-l-4 border-[var(--primary)]" : "")"
                             @onclick="() => SelectPoint(point.Id)">
                            <div class="size-4 rounded-full border border-[var(--foreground)] flex items-center justify-center text-[10px]">
                                @if (isCompleted) { <span class="text-green-500">âœ“</span> }
                                else { <span>@point.Id</span> }
                            </div>
                            <span class="text-sm truncate">@point.Label</span>
                        </div>
                    }
                }
            </div>
        </div>
    </div>

    <!-- Center: The Map (SVG) -->
    <div class="flex-1 relative bg-[var(--background)] overflow-hidden flex flex-col">
        <div class="absolute inset-0 opacity-10 pointer-events-none" 
             style="background-image: radial-gradient(#888 1px, transparent 1px); background-size: 20px 20px;">
        </div>

        <div class="flex-1 flex items-center justify-center p-8 overflow-auto">
            @if (CurrentArchetype != null)
            {
                <div class="relative w-full max-w-4xl aspect-[2/1]">
                    <svg viewBox="0 0 1 1" preserveAspectRatio="xMidYMid meet" class="w-full h-full drop-shadow-xl">
                        <!-- Path -->
                        <path d="@CurrentArchetype.Path" 
                              fill="none" 
                              stroke="var(--foreground)" 
                              stroke-width="0.004" 
                              stroke-linecap="round" 
                              class="opacity-80" />

                        <!-- Points -->
                        @foreach (var point in CurrentArchetype.Points)
                        {
                            var isSelected = SelectedPointId == point.Id;
                            var userPoint = GetUserPoint(point.Id);
                            var hasData = !string.IsNullOrWhiteSpace(userPoint?.Notes);

                            <g class="map-point cursor-pointer"
                               @onclick="() => SelectPoint(point.Id)">
                                
                                <!-- Halo for selection -->
                                @if (isSelected) 
                                {
                                    <circle cx="@point.X.ToString("F4")" cy="@point.Y.ToString("F4")" r="0.02" fill="var(--primary)" opacity="0.2" class="animate-pulse" />
                                }

                                <!-- Main Dot -->
                                <circle cx="@point.X.ToString("F4")" cy="@point.Y.ToString("F4")" r="0.012" 
                                    class="map-dot transition-transform duration-200 hover:scale-110 @(isSelected ? "scale-125" : "")"
                                    fill="@(hasData ? "var(--primary)" : "var(--background)")" 
                                    stroke="var(--foreground)" 
                                    stroke-width="0.003" />
                                
                                <text x="@point.X.ToString("F4")" y="@point.Y.ToString("F4")" 
                                      dominant-baseline="middle" text-anchor="middle" font-size="0.01" font-weight="bold" 
                                      fill="@(hasData ? "var(--background)" : "var(--foreground)")" class="pointer-events-none">
                                    @point.Id
                                </text>

                                <!-- Label -->
                                <text x="@point.X.ToString("F4")" y="@((point.Y - 0.02).ToString("F4"))" 
                                      text-anchor="middle" 
                                      font-size="0.01" font-weight="bold"
                                      class="uppercase fill-[var(--muted-foreground)] pointer-events-none select-none"
                                      style="text-shadow: 0 0.001 0.002 var(--background);">
                                    @point.Label
                                </text>
                            </g>
                        }
                    </svg>
                </div>
            }
        </div>
    </div>

    <!-- Right: Point Editor -->
    @if (SelectedPointDefinition != null)
    {
        <div class="w-full md:w-80 border-l border-[var(--border)] bg-[var(--card)] flex flex-col shadow-2xl relative z-20">
            <div class="p-4 border-b border-[var(--border)] flex justify-between items-center bg-[var(--muted)]">
                <span class="font-bold text-sm">POINT @SelectedPointDefinition.Id: @SelectedPointDefinition.Label.ToUpper()</span>
                <button @onclick="() => SelectPoint(-1)" class="text-[var(--muted-foreground)] hover:text-[var(--foreground)]">âœ•</button>
            </div>

            <div class="flex-1 p-6 overflow-y-auto space-y-6">
                <!-- The Spark / Prompt -->
                <div class="bg-[var(--background)] p-4 border-2 border-[var(--primary)] rounded-lg relative">
                    <div class="absolute -top-3 left-3 bg-[var(--background)] px-2 text-[10px] font-bold text-[var(--primary)] uppercase">
                        The Spark
                    </div>
                    <p class="text-sm font-medium italic">
                        @SelectedPointDefinition.Prompt
                    </p>
                </div>

                <!-- User Input -->
                <div class="space-y-2">
                    <label class="text-xs font-bold uppercase text-[var(--muted-foreground)]">Your Plan</label>
                    <textarea class="w-full h-40 bg-[var(--background)] border-2 border-[var(--border)] p-3 text-sm outline-none focus:border-[var(--primary)] resize-none rounded-md"
                              @bind="CurrentNoteText"
                              @bind:event="oninput"
                              placeholder="What happens here?"></textarea>
                </div>

                <!-- Literary Examples -->
                @if (SelectedPointDefinition.Examples != null && SelectedPointDefinition.Examples.Any())
                {
                   <div class="mt-4 border border-[var(--border)] rounded-md overflow-hidden">
                       <button @onclick="ToggleExamples" class="w-full px-4 py-2 bg-[var(--muted)] hover:bg-[var(--border)] text-left text-xs font-bold uppercase flex justify-between items-center transition-colors">
                           <span>Literary Inspiration</span>
                           <span>@(ShowExamples ? "âˆ’" : "+")</span>
                       </button>
                       
                       @if (ShowExamples)
                       {
                           <div class="bg-[var(--card)] p-4 space-y-4">
                                @foreach (var ex in SelectedPointDefinition.Examples)
                                {
                                    <div class="text-sm">
                                        <p class="font-bold text-[var(--primary)] mb-1">@ex.Title</p>
                                        <p class="text-[var(--muted-foreground)] italic leading-relaxed">"@ex.Content"</p>
                                    </div>
                                }
                           </div>
                       }
                   </div>
                }

                <!-- Helper Status -->
                <div class="text-xs text-[var(--muted-foreground)] flex items-center gap-2">
                    @if (SaveStatus == "Saving...") 
                    {
                        <span class="animate-pulse">ðŸ’¾ Saving...</span>
                    }
                    else if (SaveStatus == "Saved")
                    {
                        <span class="text-green-500">âœ“ Saved</span>
                    }
                </div>
            </div>
        </div>
    }
</div>

@* Code moved to Planner.razor.cs partial class *@

